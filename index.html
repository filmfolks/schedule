<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToshooT - Shooting Schedule</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- Global Styles & Fonts --- */
        :root {
            --primary-color: #3b82f6; --background-color: #111827; --surface-color: #1f2937;
            --text-color: #f3f4f6; --border-color: #374151; --success-color: #22c55e;
            --danger-color: #ef4444; --warning-color: #f59e0b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color); color: var(--text-color); margin: 0; font-size: 16px;
        }

        /* --- Header Styles --- */
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            background-color: var(--surface-color); padding: 15px 20px; border-bottom: 2px solid var(--border-color);
        }
        .page-header .header-left, .page-header .header-right {
            flex: 1; display: flex; align-items: center; gap: 15px;
        }
        .page-header .header-right { justify-content: flex-end; }
        .page-header .header-center { flex: 2; text-align: center; }
        #app-title {
            font-family: 'Roboto', sans-serif; margin: 0; font-size: 1.8rem; color: var(--primary-color);
        }

        /* --- Layout & Form Styles --- */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .section { background-color: var(--surface-color); padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); }
        .new-scene-form { border-top: 2px solid var(--border-color); margin-top: 30px; padding-top: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; background-color: #374151; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); font-size: 0.95rem; box-sizing: border-box; }
        input::placeholder { color: #9ca3af; }
        input[type="date"], input[type="time"] { color-scheme: dark; }
        #active-sequence-display {
            text-align: center; margin-bottom: 20px; font-size: 1.2rem; color: var(--primary-color);
            font-weight: 600; border: 1px solid var(--border-color); background-color: var(--background-color);
            padding: 10px; border-radius: 8px;
        }

        /* --- Floating Label Styles --- */
        .input-wrapper { position: relative; }
        .input-wrapper label {
            position: absolute; top: 50%; left: 12px; transform: translateY(-50%); color: #9ca3af;
            pointer-events: none; transition: all 0.2s ease-in-out; background-color: #374151; padding: 0 4px;
        }
        .input-wrapper .has-label:focus ~ label, .input-wrapper .has-label:valid ~ label {
            top: -8px; left: 8px; transform: translateY(0); font-size: 0.75rem; color: var(--primary-color);
        }

        /* --- Buttons & Dropdowns --- */
        button { padding: 10px 20px; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .icon-btn { background: none; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; }
        .icon-btn.small { font-size: 1.2rem; }
        .dropdown-container { position: relative; display: inline-block; }
        .dropdown-content {
            display: none; position: absolute; background-color: #374151;
            min-width: 240px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); z-index: 10;
            border-radius: 6px; overflow: hidden; margin-top: 10px; left: 0;
        }
        .dropdown-content a { color: var(--text-color); padding: 12px 20px; text-decoration: none; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .dropdown-content a:hover { background-color: var(--primary-color); }
        .dropdown-header { padding: 8px 20px; font-size: 0.8rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; cursor: default; }
        .dropdown-item { padding-left: 35px !important; }
        .dropdown-divider { border: none; height: 1px; background-color: var(--border-color); margin: 8px 0; }
        .show { display: block; }
        .auto-save-status { margin-left: auto; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; }
        .auto-save-status.off { background-color: var(--danger-color); color: white; }
        .auto-save-status.on { background-color: var(--success-color); color: white; }

        /* --- Scene Strip Styles --- */
        .scene-strips-container { display: flex; flex-direction: column; gap: 8px; }
        .scene-strip-wrapper { display: flex; align-items: center; gap: 10px; }
        .scene-strip {
            flex-grow: 1; background-color: var(--background-color); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 12px 15px; display: flex; align-items: center;
            gap: 15px; overflow-x: auto; white-space: nowrap;
        }
        .strip-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #d1d5db; padding-right: 15px; border-right: 1px solid var(--border-color); }
        .strip-item:last-of-type { border-right: none; padding-right: 0; }
        .strip-item strong { color: var(--text-color); font-weight: 600; }
        .strip-status { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .strip-status.pending { background-color: var(--warning-color); color: #111827; }
        .strip-status.not-shot { background-color: var(--danger-color); color: var(--text-color); }
        .strip-status.done { background-color: var(--success-color); color: var(--text-color); }
        .scene-actions { display: flex; align-items: center; gap: 10px; }
        .share-btn-strip { background: none; border: none; color: var(--text-color); font-size: 1.2rem; cursor: pointer; padding: 0; line-height: 1; opacity: 0.8; }
        .share-btn-strip:hover { opacity: 1; color: var(--primary-color); }
        .edit-btn-strip { background: none; border: none; color: var(--text-color); font-size: 1.2rem; cursor: pointer; padding: 0; line-height: 1; opacity: 0.8; }
        .edit-btn-strip:hover { opacity: 1; color: var(--primary-color); }


        /* --- Side Panel for Sequences --- */
        .side-panel {
            position: fixed; top: 0; right: -320px; width: 300px; height: 100%;
            background-color: var(--surface-color); box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            z-index: 2000; transition: right 0.3s ease-in-out; display: flex; flex-direction: column;
        }
        .side-panel.open { right: 0; }
        .panel-header {
            display: flex; flex-direction: column; align-items: flex-start; gap: 12px;
            padding: 15px; border-bottom: 1px solid var(--border-color);
        }
        .panel-header h3 { margin: 0; }
        .panel-actions { display: flex; align-items: center; gap: 8px; width: 100%; }
        .panel-sort { flex-grow: 1; background-color: var(--background-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; padding: 4px 6px; font-size: 0.8rem; }
        .panel-list { overflow-y: auto; padding: 10px; flex-grow: 1; }
        .sequence-item, .schedule-break-item {
            display: block; width: 100%; padding: 12px 15px; background: none; border: none;
            color: var(--text-color); text-align: left; border-radius: 6px; font-size: 1rem;
            box-sizing: border-box;
        }
        .sequence-item, .schedule-break-item { cursor: grab; }
        .sequence-item:hover { background-color: var(--background-color); }
        .sequence-item.active { background-color: var(--primary-color); font-weight: bold; }
        .schedule-break-item {
            background-color: var(--background-color); font-weight: bold;
            text-transform: uppercase; font-size: 0.8rem; color: #9ca3af;
            margin-top: 10px;
        }
        .sortable-ghost { opacity: 0.4; background: var(--primary-color); }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); animation: fadeIn 0.3s; }
        .modal-content {
            background-color: var(--surface-color); margin: 10% auto; padding: 30px;
            border: 1px solid var(--border-color); width: 90%; max-width: 700px;
            border-radius: 12px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-content.small { max-width: 450px; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-form input { background-color: var(--background-color); }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
        .info-content p { line-height: 1.6; margin: 0 0 10px; }
        .info-content strong { color: var(--primary-color); }
        .about-text { font-size: 1.2rem; text-align: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Share Card Template Styles --- */
        #share-card-template { position: absolute; left: -9999px; top: auto; width: 400px; background-color: #1f2937; color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; border-radius: 12px; border: 1px solid #3b82f6; }
        .share-card-content { padding: 25px; display: flex; flex-direction: column; gap: 10px; }
        .share-card-header { text-align: left; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; margin-bottom: 8px; }
        .share-card-header h1 { margin: 0; font-size: 2.4rem; color: var(--primary-color); }
        .share-card-header h2 { margin: 5px 0 0; font-size: 1.3rem; font-weight: 400; color: #d1d5db; }
        .share-card-item { font-size: 1.2rem; line-height: 1.5; }
        .share-card-item strong { color: #9ca3af; font-weight: 600; margin-right: 8px; }
        .share-card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .footer-project-info { text-align: left; line-height: 1.5; }
        .footer-project-info div { font-size: 0.9rem; }
        .footer-brand { text-align: right; font-weight: 600; font-size: 0.75rem; opacity: 0.5; }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 900px) {
            #app-title { font-size: 1.5rem; }
            .scene-strip { flex-wrap: wrap; white-space: normal; gap: 8px 15px; }
            .strip-item { border-right: none; padding-right: 0; }
        }
        @media (max-width: 768px) {
            body { padding: 5px; }
            .page-header { flex-wrap: wrap; padding: 10px 15px; }
            .form-grid { grid-template-columns: 1fr; }
            .modal-content { margin: 20% auto; padding: 20px; width: 95%; }
            .modal-actions { flex-direction: column-reverse; gap: 10px; }
        }
    </style>
</head>
<body>
    <header class="page-header">
        <div class="header-left">
            <div class="dropdown-container">
                <button id="hamburger-btn" class="icon-btn"><i class="fas fa-bars"></i></button>
                <div id="dropdown-menu" class="dropdown-content">
                    <a id="new-project-btn"><i class="fas fa-plus-circle"></i> Project Info</a>
                    <a id="open-project-btn"><i class="fas fa-folder-open"></i> Open Project</a>
                    <a id="new-sequence-btn"><i class="fas fa-film"></i> New Sequence</a>
                    <div class="dropdown-header">Save as...</div>
                    <a id="save-project-btn" class="dropdown-item"><i class="fas fa-save"></i> Save Project File</a>
                    <a id="save-excel-btn" class="dropdown-item"><i class="fas fa-file-excel"></i> Save Full Project Excel</a>
                    <a id="share-project-btn"><i class="fas fa-share-alt"></i> Share Project...</a>
                    <hr class="dropdown-divider">
                    <a id="auto-save-btn"><i class="fas fa-sync-alt"></i> Auto Save <span id="auto-save-status" class="auto-save-status off">OFF</span></a>
                    <a id="clear-project-btn"><i class="fas fa-eraser"></i> Clear Project</a>
                    <a id="info-btn"><i class="fas fa-info-circle"></i> Info</a>
                    <a id="about-btn"><i class="fas fa-user-friends"></i> About</a>
                </div>
            </div>
        </div>
        <div class="header-center">
            <h2 id="app-title">ToshooT</h2>
        </div>
        <div class="header-right">
            <button id="sequence-hamburger-btn" class="icon-btn"><i class="fas fa-layer-group"></i></button>
        </div>
    </header>
    
    <div class="container">
        <input type="file" id="file-input" accept=".filmproj,.json" style="display: none;">
        <div class="section" id="scheduling">
            <div id="active-sequence-display"></div>
            <div class="scene-strips-container" id="scene-strips-container"></div>
            <form id="schedule-form" class="new-scene-form">
                <h3>Add New Scene</h3>
                <div class="form-grid">
                    <input type="text" id="scene-number" placeholder="Scene #" required><input type="text" id="scene-heading" placeholder="Scene Heading" required>
                    <div class="input-wrapper"><input type="date" id="scene-date" class="has-label" required><label for="scene-date">Date</label></div>
                    <div class="input-wrapper"><input type="time" id="scene-time" class="has-label" required><label for="scene-time">Time</label></div>
                    <select id="scene-type"><option value="INT">INT.</option><option value="EXT">EXT.</option><option value="INT/EXT">INT./EXT.</option></select>
                    <input type="text" id="scene-location" placeholder="Location" required><input type="text" id="scene-pages" placeholder="Pages (e.g., 1 3/8)">
                    <input type="text" id="scene-duration" placeholder="Duration (e.g., 2h 30m)">
                    <select id="scene-status"><option value="Pending">Pending</option><option value="NOT SHOT">NOT SHOT</option><option value="Done">Done</option></select>
                    <input type="text" id="scene-cast" placeholder="Cast (e.g., John, Mary)"><input type="text" id="scene-equipment" placeholder="Key Equipment">
                    <input type="tel" id="scene-contact" placeholder="Contact Person (e.g., AD)">
                </div>
                <button type="submit" class="btn-primary">Add Scene</button>
            </form>
        </div>
    </div>

    <div id="share-card-template"></div>

    <div id="project-info-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-project-modal">&times;</span>
            <h3>Project Information</h3>
            <div class="modal-form">
                <input type="text" id="prod-name" placeholder="Production / Studio Name"><input type="text" id="director-name" placeholder="Director Name">
                <input type="tel" id="contact-number" placeholder="Contact Number"><input type="email" id="contact-email" placeholder="Email">
                <button id="save-project-info-btn" class="btn-primary">Save Info</button>
            </div>
        </div>
    </div>

    <div id="edit-scene-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-edit-modal">&times;</span>
            <h3>Edit Scene</h3>
            <input type="hidden" id="edit-scene-id">
            <div class="form-grid">
                <input type="text" id="edit-scene-number" placeholder="Scene #"><input type="text" id="edit-scene-heading" placeholder="Scene Heading">
                <input type="date" id="edit-scene-date"><input type="time" id="edit-scene-time">
                <select id="edit-scene-type"><option value="INT">INT.</option><option value="EXT">EXT.</option><option value="INT/EXT">INT./EXT.</option></select>
                <input type="text" id="edit-scene-location" placeholder="Location"><input type="text" id="edit-scene-pages" placeholder="Pages">
                <input type="text" id="edit-scene-duration" placeholder="Duration">
                <select id="edit-scene-status"><option value="Pending">Pending</option><option value="NOT SHOT">NOT SHOT</option><option value="Done">Done</option></select>
                <input type="text" id="edit-scene-cast" placeholder="Cast"><input type="text" id="edit-scene-equipment" placeholder="Key Equipment">
                <input type="tel" id="edit-scene-contact" placeholder="Contact Person">
            </div>
            <div class="modal-actions">
                <button id="delete-scene-btn" class="btn-danger">Delete Scene</button>
                <button id="save-changes-btn" class="btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="info-modal" class="modal">
        <div class="modal-content small">
            <span class="close-btn" id="close-info-modal">&times;</span>
            <h3>Field & Button Guide</h3>
            <div class="info-content">
                <p><strong>Scene #</strong>: The number of your scene (e.g., 1, 2A).</p>
                <p><strong>Scene Heading</strong>: Description from your script (e.g., INT. CAFE - DAY).</p>
                <p><strong>Status</strong>: Mark scenes as <strong>Pending</strong>, <strong>NOT SHOT</strong>, or <strong>Done</strong>.</p>
                <p><strong>Contact Person</strong>: This name is remembered for the next scene you add.</p>
                <p><strong>Edit Button (✎)</strong>: Click to open a pop-up and edit all details for that scene.</p>
                <p><strong>Sequences (Right Menu)</strong>: Group scenes into sequences. All scenes are added to the currently active sequence.</p>
            </div>
        </div>
    </div>
    <div id="about-modal" class="modal">
        <div class="modal-content small">
            <span class="close-btn" id="close-about-modal">&times;</span>
            <h3>About ToshooT</h3>
            <p class="about-text">Designed By Thosho Tech</p>
        </div>
    </div>
    
    <div id="sequence-panel" class="side-panel">
        <div class="panel-header">
            <h3>Sort Panel</h3>
            <div class="panel-actions">
                <select id="filter-by-select" class="panel-sort">
                    <option value="all">Show All Scenes</option>
                    <option value="date">Filter by Date</option>
                    <option value="status">Filter by Status</option>
                    <option value="cast">Filter by Cast</option>
                </select>
                <button id="add-schedule-break-btn" class="icon-btn small" title="Add Schedule Break"><i class="fas fa-plus"></i></button>
                <button id="export-panel-btn" class="icon-btn small" title="Export Visible Scenes"><i class="fas fa-download"></i></button>
                <button id="close-panel-btn" class="icon-btn small">&times;</button>
            </div>
            <div id="filter-controls" style="margin-top: 10px; width: 100%;"></div>
        </div>
        <div id="sequence-list" class="panel-list"></div>
    </div>

    <script>
        // =================================================================
        // --- GLOBAL STATE & DATA STRUCTURE ---
        // =================================================================
        let projectData = {
            panelItems: [],
            activeItemId: null,
            projectInfo: {}
        };
        let lastContactPerson = '';
        let activeFilter = { type: 'all', value: '' };
        let autoSaveInterval = null;

        // =================================================================
        // --- INITIALIZATION ---
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log("ToshooT Script Initializing...");
            setupEventListeners();
            loadProjectData();
            initializeDragAndDrop();
        });

        // =================================================================
        // --- SETUP ALL EVENT LISTENERS (ROBUST VERSION) ---
        // =================================================================
        function setupEventListeners() {
            const safeAddListener = (id, event, handler) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    console.error(`Error: Element with ID '${id}' not found.`);
                }
            };
            
            const addDropdownListener = (id, handler) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('click', (e) => {
                        e.preventDefault();
                        handler(e);
                        document.getElementById('dropdown-menu').classList.remove('show');
                    });
                } else {
                    console.error(`Error: Dropdown element with ID '${id}' not found.`);
                }
            };

            safeAddListener('schedule-form', 'submit', handleAddScene);

            const hamburgerBtn = document.getElementById('hamburger-btn');
            const dropdownMenu = document.getElementById('dropdown-menu');
            if(hamburgerBtn && dropdownMenu) {
                hamburgerBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('show'); });
            }
            
            addDropdownListener('new-project-btn', openProjectModal);
            addDropdownListener('open-project-btn', () => document.getElementById('file-input').click());
            addDropdownListener('new-sequence-btn', handleNewSequence);
            addDropdownListener('save-project-btn', saveProjectFile);
            addDropdownListener('save-excel-btn', () => saveAsExcel(true));
            addDropdownListener('share-project-btn', shareProject);
            addDropdownListener('clear-project-btn', clearProject);
            addDropdownListener('info-btn', () => document.getElementById('info-modal').style.display = 'block');
            addDropdownListener('about-btn', () => document.getElementById('about-modal').style.display = 'block');
            
            const autoSaveBtn = document.getElementById('auto-save-btn');
            if(autoSaveBtn) autoSaveBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAutoSave(); });

            safeAddListener('file-input', 'change', openProjectFile);

            const sequencePanel = document.getElementById('sequence-panel');
            safeAddListener('sequence-hamburger-btn', 'click', () => sequencePanel.classList.add('open'));
            safeAddListener('close-panel-btn', 'click', () => sequencePanel.classList.remove('open'));
            safeAddListener('add-schedule-break-btn', 'click', handleAddScheduleBreak);
            safeAddListener('export-panel-btn', 'click', () => saveAsExcel(false));
            safeAddListener('filter-by-select', 'change', handleFilterChange);

            safeAddListener('close-project-modal', 'click', closeProjectModal);
            safeAddListener('save-project-info-btn', 'click', handleSaveProjectInfo);
            safeAddListener('close-edit-modal', 'click', closeEditModal);
            safeAddListener('save-changes-btn', 'click', handleSaveChanges);
            safeAddListener('delete-scene-btn', 'click', handleDeleteFromModal);
            safeAddListener('close-info-modal', 'click', () => document.getElementById('info-modal').style.display = 'none');
            safeAddListener('close-about-modal', 'click', () => document.getElementById('about-modal').style.display = 'none');

            document.addEventListener('click', (event) => {
                if (hamburgerBtn && dropdownMenu && dropdownMenu.classList.contains('show') && !hamburgerBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });
        }
        
        // =================================================================
        // --- DRAG-AND-DROP INITIALIZATION ---
        // =================================================================
        function initializeDragAndDrop() {
            const listContainer = document.getElementById('sequence-list');
            if(listContainer){
                new Sortable(listContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const item = projectData.panelItems.splice(evt.oldIndex, 1)[0];
                        projectData.panelItems.splice(evt.newIndex, 0, item);
                        saveProjectData();
                    }
                });
            }
        }

        // =================================================================
        // --- SEQUENCE & SCHEDULE BREAK MANAGEMENT ---
        // =================================================================
        function handleNewSequence() {
            let name = prompt("Enter a name for the new sequence:");
            if (name === null) return;
            if (name.trim() === "") name = `Sequence ${projectData.panelItems.filter(i => i.type === 'sequence').length + 1}`;
            const newItem = { type: 'sequence', id: Date.now(), name: name, scenes: [] };
            projectData.panelItems.push(newItem);
            setActiveItem(newItem.id);
        }

        function handleAddScheduleBreak() {
            let name = prompt("Enter a name for the schedule break (e.g., DAY 1):");
            if (name === null || name.trim() === "") return;
            const newItem = { type: 'schedule_break', id: Date.now(), name: name };
            projectData.panelItems.push(newItem);
            saveProjectData();
            renderSequencePanel();
        }

        function setActiveItem(id) {
            const item = projectData.panelItems.find(i => i.id === id);
            if (item && item.type === 'sequence') {
                projectData.activeItemId = id;
                saveProjectData();
                renderSchedule();
                renderSequencePanel();
                document.getElementById('sequence-panel').classList.remove('open');
            }
        }

        function renderSequencePanel() {
            const listContainer = document.getElementById('sequence-list');
            listContainer.innerHTML = '';
            projectData.panelItems.forEach(item => {
                const element = document.createElement('div');
                if (item.type === 'sequence') {
                    element.className = `sequence-item ${item.id === projectData.activeItemId ? 'active' : ''}`;
                    element.textContent = item.name;
                    element.onclick = () => setActiveItem(item.id);
                } else if (item.type === 'schedule_break') {
                    element.className = 'schedule-break-item';
                    element.textContent = item.name;
                }
                listContainer.appendChild(element);
            });
        }
        
        // =================================================================
        // --- FILTERING LOGIC ---
        // =================================================================
        function handleFilterChange(e) {
            renderFilterControls();
        }
        
        function renderFilterControls() {
            const filterContainer = document.getElementById('filter-controls');
            filterContainer.innerHTML = '';
            const filterType = document.getElementById('filter-by-select').value;
        
            if (filterType === 'all') {
                activeFilter = { type: 'all', value: '' };
                renderSchedule();
                return;
            }
        
            let inputElement;
            if (filterType === 'date') {
                inputElement = document.createElement('input');
                inputElement.type = 'date';
                inputElement.className = 'panel-sort';
            } else if (filterType === 'status') {
                inputElement = document.createElement('select');
                inputElement.className = 'panel-sort';
                inputElement.innerHTML = `
                    <option value="">Select Status</option>
                    <option value="Pending">Pending</option>
                    <option value="NOT SHOT">NOT SHOT</option>
                    <option value="Done">Done</option>
                `;
            } else if (filterType === 'cast') {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.placeholder = 'Enter Cast Name';
                inputElement.className = 'panel-sort';
            }
        
            if (inputElement) {
                const updateFilter = (e) => {
                    activeFilter = { type: filterType, value: e.target.value.trim().toLowerCase() };
                    renderSchedule();
                };
                inputElement.addEventListener('change', updateFilter);
                if (inputElement.type === 'text') {
                     inputElement.addEventListener('keyup', updateFilter);
                }
                filterContainer.appendChild(inputElement);
                activeFilter = { type: filterType, value: '' };
                renderSchedule();
            }
        }

        function getVisibleScenes() {
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence || activeSequence.type !== 'sequence') return [];
            
            const allScenes = activeSequence.scenes;

            if (activeFilter.type === 'all' || !activeFilter.value) { return allScenes; }

            return allScenes.filter(scene => {
                if (!scene.hasOwnProperty(activeFilter.type)) return false;
                const sceneValue = (scene[activeFilter.type] || '').toString().toLowerCase();
                const filterValue = activeFilter.value.toLowerCase();
                return sceneValue.includes(filterValue);
            });
        }
        
        function resetFilter() {
            activeFilter = { type: 'all', value: '' };
            const filterSelect = document.getElementById('filter-by-select');
            if (filterSelect) filterSelect.value = 'all';
            renderFilterControls();
        }

        // =================================================================
        // --- CORE SCHEDULE FUNCTIONS ---
        // =================================================================
        function handleAddScene(e) {
            e.preventDefault();
            let activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence || activeSequence.type !== 'sequence') {
                if (confirm("No sequence created. Would you like to create 'Sequence 1' to add this scene?")) {
                    handleNewSequence();
                    activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
                    if(!activeSequence) return;
                } else { return; }
            }
            const newScene = {
                id: Date.now(), number: document.getElementById('scene-number').value,
                heading: document.getElementById('scene-heading').value, date: document.getElementById('scene-date').value,
                time: document.getElementById('scene-time').value, type: document.getElementById('scene-type').value,
                location: document.getElementById('scene-location').value, pages: document.getElementById('scene-pages').value,
                duration: document.getElementById('scene-duration').value, status: document.getElementById('scene-status').value,
                cast: document.getElementById('scene-cast').value, equipment: document.getElementById('scene-equipment').value,
                contact: document.getElementById('scene-contact').value,
            };
            activeSequence.scenes.push(newScene);
            lastContactPerson = newScene.contact;
            saveProjectData();
            resetFilter();
            renderSchedule();
            e.target.reset();
            document.getElementById('scene-contact').value = lastContactPerson;
        }

        function renderSchedule() {
            const container = document.getElementById('scene-strips-container');
            const display = document.getElementById('active-sequence-display');
            container.innerHTML = '';
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence || activeSequence.type !== 'sequence') {
                display.textContent = 'No active sequence. Create or select a sequence.';
                return;
            }
            display.textContent = `Current Sequence: ${activeSequence.name}`;
            const scenesToRender = getVisibleScenes();
            if (scenesToRender.length === 0 && activeFilter.type !== 'all') {
                container.innerHTML = `<p style="text-align:center; color: #9ca3af;">No scenes match the current filter.</p>`;
            } else {
                scenesToRender.forEach(scene => {
                    const stripWrapper = document.createElement('div');
                    stripWrapper.className = 'scene-strip-wrapper';
                    const statusClass = scene.status.replace(/\s+/g, '-').toLowerCase();
                    stripWrapper.innerHTML = `
                        <div class="scene-strip" id="scene-strip-${scene.id}">
                            <div class="strip-item"><strong>#${scene.number}</strong></div><div class="strip-item">${scene.heading}</div>
                            <div class="strip-item">${formatDateDDMMYYYY(scene.date)}</div><div class="strip-item">${formatTime12Hour(scene.time)}</div>
                            <div class="strip-item">${scene.type}. ${scene.location}</div>
                            <div class="strip-item">Pages: <strong>${scene.pages || 'N/A'}</strong></div>
                            <div class="strip-item">Duration: <strong>${scene.duration || 'N/A'}</strong></div>
                            <div class="strip-item">Cast: <strong>${scene.cast || 'N/A'}</strong></div>
                            <div class="strip-item">Equipment: <strong>${scene.equipment || 'N/A'}</strong></div>
                            <div class="strip-item"><span class="strip-status ${statusClass}">${scene.status}</span></div>
                        </div>
                        <div class="scene-actions">
                            <button class="edit-btn-strip" title="Edit Scene"><i class="fas fa-pencil-alt"></i></button>
                            <button class="share-btn-strip" title="Share as Image"><i class="fas fa-share-alt"></i></button>
                        </div>
                    `;
                    stripWrapper.querySelector('.edit-btn-strip').addEventListener('click', () => openEditModal(scene.id));
                    stripWrapper.querySelector('.share-btn-strip').addEventListener('click', () => shareScene(scene.id));
                    container.appendChild(stripWrapper);
                });
            }
        }

        function deleteScene(id) {
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence) return;
            activeSequence.scenes = activeSequence.scenes.filter(scene => scene.id !== id);
            saveProjectData();
            renderSchedule();
        }

        // =================================================================
        // --- DATA PERSISTENCE & PROJECT FILES ---
        // =================================================================
        function saveProjectData(isBackup = false) {
            const key = isBackup ? 'projectData_backup' : 'projectData';
            localStorage.setItem(key, JSON.stringify(projectData));
        }
        function loadProjectData() {
            let savedData = localStorage.getItem('projectData');
            const backupData = localStorage.getItem('projectData_backup');
            if (!savedData && backupData) {
                if (confirm("No main save data found, but a backup exists. Would you like to restore the backup?")) {
                    savedData = backupData;
                    localStorage.setItem('projectData', backupData);
                }
            }
            projectData = savedData ? JSON.parse(savedData) : { panelItems: [], activeItemId: null, projectInfo: {} };
            if (!projectData.projectInfo) projectData.projectInfo = {};
            if (!projectData.panelItems) projectData.panelItems = [];
            if (projectData.activeItemId === null && projectData.panelItems.length > 0) {
                const firstSequence = projectData.panelItems.find(i => i.type === 'sequence');
                if (firstSequence) projectData.activeItemId = firstSequence.id;
            }
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (activeSequence && activeSequence.scenes && activeSequence.scenes.length > 0) {
                lastContactPerson = activeSequence.scenes[activeSequence.scenes.length - 1].contact || '';
            }
            const contactInput = document.getElementById('scene-contact');
            if (contactInput) contactInput.value = lastContactPerson;
            renderSchedule();
            renderSequencePanel();
        }
        function clearProject() {
            if (confirm('Are you sure you want to clear the entire project? This action cannot be undone.')) {
                projectData = { panelItems: [], activeItemId: null, projectInfo: {} };
                lastContactPerson = '';
                saveProjectData();
                renderSchedule();
                renderSequencePanel();
            }
        }
        function saveProjectFile() {
             try {
                const projectInfo = projectData.projectInfo || {};
                const projectName = projectInfo.prodName || 'UntitledProject';
                const dataStr = JSON.stringify(projectData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}.filmproj`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Error saving project file:", error);
                alert("Could not save project file. See console for details.");
            }
        }
        function openProjectFile(event) {
            const file = event.target.files[0];
            if (!file) { return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object' && Array.isArray(data.panelItems) && data.hasOwnProperty('projectInfo')) {
                        if (confirm("This will replace your current project. Are you sure you want to proceed?")) {
                            projectData = data;
                            if (!projectData.projectInfo) projectData.projectInfo = {};
                            if (!projectData.panelItems) projectData.panelItems = [];
                            if (projectData.activeItemId === null && projectData.panelItems.length > 0) {
                                const firstSequence = projectData.panelItems.find(i => i.type === 'sequence');
                                if (firstSequence) projectData.activeItemId = firstSequence.id;
                            }
                            saveProjectData();
                            loadProjectData();
                            alert("Project loaded successfully.");
                        }
                    } else {
                        alert("Invalid project file format.");
                    }
                } catch (error) {
                    console.error("Error opening project file:", error);
                    alert("Could not open project file. It may be corrupted or in the wrong format.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.onerror = () => {
                alert("Error reading file.");
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // =================================================================
        // --- MODAL LOGIC ---
        // =================================================================
        function openProjectModal() {
            const projectInfo = projectData.projectInfo || {};
            document.getElementById('prod-name').value = projectInfo.prodName || '';
            document.getElementById('director-name').value = projectInfo.directorName || '';
            document.getElementById('contact-number').value = projectInfo.contactNumber || '';
            document.getElementById('contact-email').value = projectInfo.contactEmail || '';
            document.getElementById('project-info-modal').style.display = 'block';
        }
        function closeProjectModal() { document.getElementById('project-info-modal').style.display = 'none'; }
        function handleSaveProjectInfo() {
            projectData.projectInfo = {
                prodName: document.getElementById('prod-name').value, directorName: document.getElementById('director-name').value,
                contactNumber: document.getElementById('contact-number').value, contactEmail: document.getElementById('contact-email').value
            };
            saveProjectData();
            closeProjectModal();
        }
        function openEditModal(id) {
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence) return;
            const scene = activeSequence.scenes.find(s => s.id === id);
            if (!scene) return;
            document.getElementById('edit-scene-id').value = scene.id;
            document.getElementById('edit-scene-number').value = scene.number;
            document.getElementById('edit-scene-heading').value = scene.heading;
            document.getElementById('edit-scene-date').value = scene.date;
            document.getElementById('edit-scene-time').value = scene.time;
            document.getElementById('edit-scene-type').value = scene.type;
            document.getElementById('edit-scene-location').value = scene.location;
            document.getElementById('edit-scene-pages').value = scene.pages;
            document.getElementById('edit-scene-duration').value = scene.duration;
            document.getElementById('edit-scene-status').value = scene.status;
            document.getElementById('edit-scene-cast').value = scene.cast;
            document.getElementById('edit-scene-equipment').value = scene.equipment;
            document.getElementById('edit-scene-contact').value = scene.contact;
            document.getElementById('edit-scene-modal').style.display = 'block';
        }
        function closeEditModal() { document.getElementById('edit-scene-modal').style.display = 'none'; }
        function handleSaveChanges() {
            const sceneId = parseInt(document.getElementById('edit-scene-id').value);
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence) return;
            const sceneIndex = activeSequence.scenes.findIndex(s => s.id === sceneId);
            if (sceneIndex === -1) return;
            activeSequence.scenes[sceneIndex] = {
                id: sceneId, number: document.getElementById('edit-scene-number').value,
                heading: document.getElementById('edit-scene-heading').value, date: document.getElementById('edit-scene-date').value,
                time: document.getElementById('edit-scene-time').value, type: document.getElementById('edit-scene-type').value,
                location: document.getElementById('edit-scene-location').value, pages: document.getElementById('edit-scene-pages').value,
                duration: document.getElementById('edit-scene-duration').value, status: document.getElementById('edit-scene-status').value,
                cast: document.getElementById('edit-scene-cast').value, equipment: document.getElementById('edit-scene-equipment').value,
                contact: document.getElementById('edit-scene-contact').value
            };
            saveProjectData();
            renderSchedule();
            closeEditModal();
        }
        function handleDeleteFromModal() {
            if(confirm("Are you sure you want to delete this scene?")) {
                const sceneId = parseInt(document.getElementById('edit-scene-id').value);
                deleteScene(sceneId);
                closeEditModal();
            }
        }

        // =================================================================
        // --- EXPORT & SHARE FUNCTIONS ---
        // =================================================================
        function saveAsExcel(isFullProject = false) {
            const projectInfo = projectData.projectInfo || {};
            const workbook = XLSX.utils.book_new();

            // This helper function creates a single, nicely formatted sheet.
            const createSheet = (scenes, sheetName) => {
                // Find the schedule break (e.g., DAY 1) associated with this sequence
                let scheduleBreakName = 'Uncategorized';
                const sequenceIndex = projectData.panelItems.findIndex(item => item.name === sheetName && item.type === 'sequence');
                if (sequenceIndex > -1) {
                    for (let i = sequenceIndex - 1; i >= 0; i--) {
                        if (projectData.panelItems[i].type === 'schedule_break') {
                            scheduleBreakName = projectData.panelItems[i].name;
                            break;
                        }
                    }
                }

                // Define all headers
                const projectHeader = [
                    ["Production:", projectInfo.prodName || 'N/A', null, "Director:", projectInfo.directorName || 'N/A'],
                    ["Contact:", projectInfo.contactNumber || 'N/A', null, "Email:", projectInfo.contactEmail || 'N/A'],
                    [],
                    [`Schedule Break: ${scheduleBreakName}`],
                    [`Sequence: ${sheetName}`],
                    []
                ];
                const tableHeader = ['Scene #', 'Scene Heading', 'Date', 'Time', 'Type', 'Location', 'Pages', 'Duration', 'Status', 'Cast', 'Key Equipment', 'Contact'];
                
                // Format scene data into an array of arrays
                const tableBody = scenes.map(s => [
                    s.number, s.heading, formatDateDDMMYYYY(s.date), s.time, s.type, s.location, s.pages, s.duration, s.status, s.cast, s.equipment, s.contact
                ]);

                // Combine all data for the sheet
                const fullSheetData = projectHeader.concat([tableHeader]).concat(tableBody);
                const worksheet = XLSX.utils.aoa_to_sheet(fullSheetData);

                // Add cell merges for a professional look
                const numCols = tableHeader.length - 1;
                worksheet['!merges'] = [
                    { s: { r: 0, c: 1 }, e: { r: 0, c: 2 } }, { s: { r: 0, c: 4 }, e: { r: 0, c: numCols } },
                    { s: { r: 1, c: 1 }, e: { r: 1, c: 2 } }, { s: { r: 1, c: 4 }, e: { r: 1, c: numCols } },
                    { s: { r: 3, c: 0 }, e: { r: 3, c: numCols } }, { s: { r: 4, c: 0 }, e: { r: 4, c: numCols } }
                ];
                
                // Set column widths for readability
                if (scenes.length > 0) {
                     const colWidths = tableHeader.map((_, i) => {
                        const allValues = [tableHeader[i] || ''].concat(tableBody.map(row => (row[i] || '').toString()));
                        const maxLength = Math.max(...allValues.map(val => val.length));
                        return { wch: Math.min(50, Math.max(12, maxLength + 2)) };
                    });
                    worksheet['!cols'] = colWidths;
                }

                return worksheet;
            };

            // LOGIC FOR "Save Full Project Excel"
            if (isFullProject) {
                projectData.panelItems.forEach(item => {
                    if (item.type === 'sequence' && item.scenes.length > 0) {
                        const worksheet = createSheet(item.scenes, item.name);
                        XLSX.utils.book_append_sheet(workbook, worksheet, item.name.replace(/[/\\?*:[\]]/g, '').substring(0, 31));
                    }
                });
                if(workbook.SheetNames.length === 0){ alert("No scenes in any sequence to export."); return;}
                XLSX.writeFile(workbook, `${(projectInfo.prodName || 'FullProject').replace(/[^a-zA-Z0-9]/g, '_')}_Schedule.xlsx`);
            
            // LOGIC FOR "Export Visible Scenes" from the Sort Panel
            } else {
                const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
                if (!activeSequence) { alert("Please select a sequence to export."); return; }
                const scenesToExport = getVisibleScenes();
                if (scenesToExport.length === 0) { alert(`No visible scenes in "${activeSequence.name}" to export.`); return; }
                
                const worksheet = createSheet(scenesToExport, activeSequence.name);
                XLSX.utils.book_append_sheet(workbook, worksheet, activeSequence.name.replace(/[/\\?*:[\]]/g, '').substring(0, 31));
                XLSX.writeFile(workbook, `${activeSequence.name.replace(/[^a-zA-Z0-9]/g, '_')}_Schedule.xlsx`);
            }
        }
        
        async function shareProject() {
            const projectInfo = projectData.projectInfo || {};
            const totalSequences = projectData.panelItems.filter(i => i.type === 'sequence').length;
            const totalScenes = projectData.panelItems
                .filter(i => i.type === 'sequence')
                .reduce((sum, seq) => sum + (seq.scenes ? seq.scenes.length : 0), 0);

            const shareText = `*ToshooT Project Summary*\nProduction: ${projectInfo.prodName || 'N/A'}\nDirector: ${projectInfo.directorName || 'N/A'}\nContact: ${projectInfo.contactNumber || 'N/A'}\n\nTotal Sequences: ${totalSequences}\nTotal Scenes: ${totalScenes}`;

            if (navigator.share) {
                try {
                    await navigator.share({ title: `Project: ${projectInfo.prodName || 'Untitled'}`, text: shareText });
                } catch (err) { console.error("Share failed:", err); }
            } else {
                try {
                    await navigator.clipboard.writeText(shareText);
                    alert("Project info copied to clipboard!");
                } catch (err) { alert("Sharing is not supported on this browser, and copying to clipboard failed."); }
            }
        }
        
        async function shareScene(id) {
            const activeSequence = projectData.panelItems.find(item => item.id === projectData.activeItemId);
            if (!activeSequence) return;
            const scene = activeSequence.scenes.find(s => s.id === id);
            if (!scene) return;
            const projectInfo = projectData.projectInfo || {};

            const template = document.getElementById('share-card-template');
            template.innerHTML = `
                <div class="share-card-content">
                    <div class="share-card-header">
                        <h1>Scene ${scene.number || 'N/A'}</h1>
                        <h2>${scene.heading || 'N/A'}</h2>
                    </div>
                    <div class="share-card-item"><strong>Date:</strong> ${formatDateDDMMYYYY(scene.date)}</div>
                    <div class="share-card-item"><strong>Time:</strong> ${formatTime12Hour(scene.time)}</div>
                    <div class="share-card-item"><strong>Location:</strong> ${scene.type}. ${scene.location}</div>
                    <div class="share-card-item"><strong>Cast:</strong> ${scene.cast || 'N/A'}</div>
                    <div class="share-card-item"><strong>Pages:</strong> ${scene.pages || 'N/A'}</div>
                    <div class="share-card-footer">
                        <div class="footer-project-info">
                            <div><strong>${projectInfo.prodName || 'Production'}</strong></div>
                            <div>${projectInfo.directorName ? 'Dir: ' + projectInfo.directorName : ''}</div>
                        </div>
                        <div class="footer-brand">Powered by ToshooT</div>
                    </div>
                </div>
            `;
            
            try {
                const canvas = await html2canvas(template, { useCORS: true, backgroundColor: '#1f2937' });
                canvas.toBlob(async (blob) => {
                    const fileName = `Scene_${scene.number}.png`;
                    const file = new File([blob], fileName, { type: 'image/png' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: `Shooting Info: Scene ${scene.number}`,
                            text: `Details for Scene ${scene.number} - ${scene.heading}`,
                            files: [file]
                        });
                    } else {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = fileName;
                        link.click();
                        URL.revokeObjectURL(link.href);
                    }
                }, 'image/png');
            } catch (err) {
                console.error("Failed to share scene:", err);
                alert("Could not generate shareable image.");
            }
        }
        
        // =================================================================
        // --- UTILITY FUNCTIONS ---
        // =================================================================
        function formatTime12Hour(timeString) {
            if (!timeString) return "N/A";
            const [hour, minute] = timeString.split(':');
            const hourInt = parseInt(hour, 10);
            const ampm = hourInt >= 12 ? 'PM' : 'AM';
            const hour12 = hourInt % 12 || 12;
            return `${hour12}:${minute} ${ampm}`;
        }
        function formatDateDDMMYYYY(dateString) {
            if (!dateString || dateString.indexOf('-') === -1) return dateString || "N/A";
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        function toggleAutoSave() {
            const statusEl = document.getElementById('auto-save-status');
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
                statusEl.textContent = 'OFF';
                statusEl.className = 'auto-save-status off';
            } else {
                autoSaveInterval = setInterval(() => {
                    saveProjectData(false); 
                    saveProjectData(true); 
                }, 120000); 
                statusEl.textContent = 'ON';
                statusEl.className = 'auto-save-status on';
                alert('Auto-save is now ON. Your project will be saved to this browser\'s storage every 2 minutes.');
            }
        }
    </script>
</body>
</html>
